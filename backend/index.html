<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC System Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stats-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        video {
            width: 100%;
            max-width: 640px;
            border-radius: 4px;
        }

        h2 {
            margin-top: 0;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
        }

        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #45a049;
        }

        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status.error {
            background-color: #ffe6e6;
            color: #d63031;
        }

        .status.success {
            background-color: #e6ffe6;
            color: #27ae60;
        }

        canvas {
            width: 100% !important;
            height: 200px !important;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <h1>WebRTC System Monitor</h1>
    <div class="container">
        <div class="video-container">
            <h2>Video Streams</h2>
            <button id="startButton" class="button">Start Camera</button>
            <div id="videoStatus" class="status"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <div>
                    <h3>Local Stream</h3>
                    <video id="localVideo" autoplay playsinline muted></video>
                </div>
                <div>
                    <h3>Processed Stream</h3>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <h2>System Resources</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-title">CPU Usage</div>
                    <div class="stat-value" id="cpuUsage">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Memory Usage</div>
                    <div class="stat-value" id="memoryUsage">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">GPU Usage</div>
                    <div class="stat-value" id="gpuUsage">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">GPU Memory</div>
                    <div class="stat-value" id="gpuMemory">-</div>
                </div>
            </div>
            <canvas id="resourceChart"></canvas>
        </div>
    </div>

    <script>
        let pc = null;
        let resourceChart = null;
        const chartData = {
            labels: [],
            datasets: [
                { label: 'CPU Usage', data: [], borderColor: 'rgb(75, 192, 192)', tension: 0.1 },
                { label: 'GPU Usage', data: [], borderColor: 'rgb(255, 99, 132)', tension: 0.1 }
            ]
        };

        function initChart() {
            const ctx = document.getElementById('resourceChart').getContext('2d');
            resourceChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        async function startSSE() {
            const eventSource = new EventSource('http://localhost:8080/system_info');
            eventSource.onmessage = function (event) {
                const message = JSON.parse(event.data);

                if (message.type === "system_info") {
                    const data = message.data;

                    // Update CPU data
                    if (data.cpu) {
                        document.getElementById('cpuUsage').textContent = `${data.cpu.total}%`;
                        document.getElementById('memoryUsage').textContent = `${data.cpu.memory}%`;

                        // Append data to chart
                        const now = new Date().toLocaleTimeString();
                        chartData.labels.push(now);
                        chartData.datasets[0].data.push(data.cpu.total);

                        // Keep chart to the last 10 data points
                        if (chartData.labels.length > 10) {
                            chartData.labels.shift();
                            chartData.datasets.forEach(dataset => dataset.data.shift());
                        }
                    }

                    // Update GPU data if available
                    if (data.gpu) {
                        document.getElementById('gpuUsage').textContent = `${data.gpu.utilization}%`;
                        document.getElementById('gpuMemory').textContent =
                            `${data.gpu.memory_used}/${data.gpu.memory_total} MB`;

                        // Add GPU usage data to the chart
                        chartData.datasets[1].data.push(data.gpu.utilization);
                    } else {
                        // Handle cases where there is no GPU data
                        document.getElementById('gpuUsage').textContent = 'N/A';
                        document.getElementById('gpuMemory').textContent = 'N/A';
                    }

                    resourceChart.update();
                }
            };
        }

        async function createPeerConnection() {
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

            pc.ontrack = function (event) {
                if (event.track.kind === 'video') {
                    const remoteVideo = document.getElementById('remoteVideo');
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            pc.oniceconnectionstatechange = function () {
                const status = document.getElementById('videoStatus');
                status.textContent = `Connection State: ${pc.iceConnectionState}`;
                status.className = `status ${pc.iceConnectionState === 'connected' ? 'success' : ''}`;
            };

            return pc;
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = stream;

                pc = await createPeerConnection();
                stream.getTracks().forEach(track => pc.addTrack(track, stream));

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const response = await fetch('http://localhost:8080/offer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type })
                });

                const answer = await response.json();
                await pc.setRemoteDescription(answer);

                document.getElementById('startButton').disabled = true;
                document.getElementById('videoStatus').textContent = 'Camera started successfully';
                document.getElementById('videoStatus').className = 'status success';

                startSSE();
            } catch (e) {
                console.error(e);
                document.getElementById('videoStatus').textContent = `Error: ${e.message}`;
                document.getElementById('videoStatus').className = 'status error';
            }
        }

        function initialize() {
            initChart();
            document.getElementById('startButton').addEventListener('click', startCamera);
        }

        initialize();
    </script>

</body>

</html>